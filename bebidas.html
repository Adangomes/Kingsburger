// ==================================================
// CONFIGURA칂칏ES GLOBAIS
// ==================================================
let LOJA_ABERTA = true;
let MENSAGEM_FECHADA = "Estamos fechados no momento 游땞";
const carrinho = [];

// ==================================================
// STATUS DA LOJA (Netlify CMS)
// ==================================================
async function carregarStatusLoja() {
    try {
        const res = await fetch('/content/status.json');
        const data = await res.json();

        LOJA_ABERTA = data.aberto;
        MENSAGEM_FECHADA = data.mensagem || MENSAGEM_FECHADA;

        const statusEl = document.getElementById("status-loja");
        if (statusEl) {
            statusEl.textContent = LOJA_ABERTA ? "游릭 ABERTO" : "游댮 FECHADO";
            statusEl.className = LOJA_ABERTA ? "status aberto" : "status fechado";
        }
    } catch (e) {
        console.error("Erro ao carregar status da loja", e);
    }
}

// ==================================================
// BAIRROS E TAXAS
// ==================================================
const bairrosJaragua = [
    "Centro","Amizade","Baependi","Barra do Rio Cerro","Boa Vista",
    "Czerniewicz","Ilha da Figueira","Jaragu치 84","Jaragu치 Esquerdo",
    "Jo칚o Pessoa","Nova Bras칤lia","Nereu Ramos","Rau","Rio Cerro I",
    "Rio Cerro II","Rio da Luz","Tifa Martins","Tr칡s Rios do Sul",
    "Vieira","Vila Lenzi"
];

const bairrosGuaramirim = [
    "Centro","Amizade","Ava칤","Bananal do Sul","Corticeira",
    "Figueirinha","Guamiranga","Imigrantes","Jo칚o Pessoa",
    "Nova Esperan칞a","Recanto Feliz","Rio Branco","Rua Nova",
    "Sele칞칚o","Escolinha"
];

function carregarBairros() {
    const cidade = document.getElementById("cidade").value;
    const bairroSelect = document.getElementById("bairro");
    bairroSelect.innerHTML = "";

    let lista = [];
    if (cidade === "jaragua") lista = bairrosJaragua;
    if (cidade === "guaramirim") lista = bairrosGuaramirim;

    lista.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        bairroSelect.appendChild(opt);
    });
}

function calcularTaxaEntrega(cidade, bairro) {
    if (cidade === "jaragua") return 20;
    if (cidade === "guaramirim") {
        if (bairro === "Centro") return 10;
        if (bairro === "Escolinha") return 5;
        return 15;
    }
    return 0;
}

// ==================================================
// CARRINHO
// ==================================================
function adicionarAoCarrinho(nome, codigo, preco) {
    if (!LOJA_ABERTA) {
        alert(MENSAGEM_FECHADA);
        return;
    }

    const existente = carrinho.find(i => i.nome === nome && i.codigo === codigo);
    if (existente) existente.quantidade++;
    else carrinho.push({ nome, codigo, preco, quantidade: 1 });

    salvarCarrinho();
    atualizarCarrinho();
    abrirCarrinho();
}

function atualizarCarrinho() {
    const container = document.getElementById("cart-items");
    if (!container) return;

    container.innerHTML = "";
    let subtotal = 0;

    carrinho.forEach((item, index) => {
        subtotal += item.preco * item.quantidade;

        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
            <div>${item.quantidade}x ${item.nome}</div>
            <button onclick="removerItem(${index})">Excluir</button>
        `;
        container.appendChild(div);
    });

    document.getElementById("subtotal").innerText =
        `Subtotal: R$${subtotal.toFixed(2).replace(".", ",")}`;
    document.getElementById("total").innerText =
        `Total: R$${subtotal.toFixed(2).replace(".", ",")}`;
}

function removerItem(index) {
    carrinho.splice(index, 1);
    salvarCarrinho();
    atualizarCarrinho();
}

function limparCarrinho() {
    carrinho.length = 0;
    localStorage.removeItem("meuCarrinho");
    atualizarCarrinho();
}

function salvarCarrinho() {
    localStorage.setItem("meuCarrinho", JSON.stringify(carrinho));
}

function carregarCarrinhoSalvo() {
    const salvo = localStorage.getItem("meuCarrinho");
    if (salvo) carrinho.push(...JSON.parse(salvo));
}

// ==================================================
// MODAIS
// ==================================================
function abrirCarrinho() {
    document.getElementById("cart-modal").style.display = "flex";
}
function fecharCarrinho() {
    document.getElementById("cart-modal").style.display = "none";
}
function abrirDelivery() {
    fecharCarrinho();
    document.getElementById("delivery-modal").style.display = "flex";
}
function fecharDelivery() {
    document.getElementById("delivery-modal").style.display = "none";
}

function toggleTroco() {
    const pagamento = document.getElementById("pagamento").value;
    document.getElementById("troco-box").style.display =
        pagamento === "Dinheiro" ? "block" : "none";
}

// ==================================================
// RESUMO E FINALIZA칂츾O
// ==================================================
function mostrarResumo() {
    const campos = ["nomeCliente","cidade","bairro","rua","numero","pagamento"];
    for (let id of campos) {
        if (!document.getElementById(id).value) {
            alert("Preencha todos os campos obrigat칩rios!");
            return;
        }
    }

    let subtotal = carrinho.reduce((s, i) => s + i.preco * i.quantidade, 0);
    let taxa = calcularTaxaEntrega(
        document.getElementById("cidade").value,
        document.getElementById("bairro").value
    );

    const resumoItens = document.getElementById("resumo-itens");
    resumoItens.innerHTML = "";

    carrinho.forEach(item => {
        const div = document.createElement("div");
        div.textContent = `${item.quantidade}x ${item.nome}`;
        resumoItens.appendChild(div);
    });

    document.getElementById("resumo-taxa").innerText =
        `Taxa: R$${taxa.toFixed(2).replace(".", ",")}`;
    document.getElementById("resumo-total").innerText =
        `Total: R$${(subtotal + taxa).toFixed(2).replace(".", ",")}`;

    document.getElementById("step1-buttons").style.display = "none";
    document.getElementById("resumo-pedido").style.display = "block";
}

function voltarFormulario() {
    document.getElementById("resumo-pedido").style.display = "none";
    document.getElementById("step1-buttons").style.display = "flex";
}

function finalizarEntrega() {
    if (carrinho.length === 0) {
        alert("Carrinho vazio!");
        return;
    }

    const numeroWhatsApp = "5547997278232";
    const mensagem = "Ol치! Gostaria de fazer um pedido.";
    window.open(`https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensagem)}`, "_blank");
}

// ==================================================
// PRODUTOS (Netlify CMS)
// ==================================================
async function carregarProdutos() {
    try {
        const res = await fetch('/content/produtos.json');
        const data = await res.json();

        const containers = {
            burger: document.getElementById("burgers"),
            bebida: document.getElementById("bebidas")
        };

        data.produtos.forEach(prod => {
            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
                <img src="${prod.image}" alt="${prod.title}">
                <h3>${prod.title}</h3>
                <p class="desc">${prod.ingredientes || ""}</p>
                <p class="price">R$ ${prod.price.toFixed(2).replace(".", ",")}</p>
                <button class="btn"
                    onclick="adicionarAoCarrinho('${prod.title}','${prod.codigo}',${prod.price})">
                    Adicionar
                </button>
            `;
            containers[prod.categoria]?.appendChild(card);
        });
    } catch (e) {
        console.error("Erro ao carregar produtos", e);
    }
}

// ==================================================
// INIT
// ==================================================
document.addEventListener("DOMContentLoaded", () => {
    carregarStatusLoja();
    carregarCarrinhoSalvo();
    atualizarCarrinho();
    carregarProdutos();
});
